#!/usr/bin/env bash
# install_ssl.sh – Cài đặt SSL certificate và private key cho Aiko-Server
# Usage: sudo bash install_ssl.sh

set -euo pipefail

CERT_DIR="/etc/Aiko-Server/cert"
CERT_FILE="$CERT_DIR/aiko_server.cert"
KEY_FILE="$CERT_DIR/aiko_server.key"

echo "==> 1. Tạo thư mục chứng chỉ nếu chưa tồn tại"
mkdir -p "$CERT_DIR"
chmod 700 "$CERT_DIR"

echo "==> 2. Ghi chứng chỉ vào $CERT_FILE"
cat > "$CERT_FILE" <<'EOF'
-----BEGIN CERTIFICATE-----
MIIEFTCCAv2gAwIBAgIURse96pXV8SNMzv6VS0HXMD1WJQ0wDQYJKoZIhvcNAQEL
BQAwgagxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQH
Ew1TYW4gRnJhbmNpc2NvMRkwFwYDVQQKExBDbG91ZGZsYXJlLCBJbmMuMRswGQYD
VQQLExJ3d3cuY2xvdWRmbGFyZS5jb20xNDAyBgNVBAMTK01hbmFnZWQgQ0EgZTY3
ZDMyMWRmNTg2ZWRhMWU3ZDM5ZDM4YmRjYzQwOTYwHhcNMjUwNTA4MDMwMTAwWhcN
NDAwNTA0MDMwMTAwWjAiMQswCQYDVQQGEwJVUzETMBEGA1UEAxMKQ2xvdWRmbGFy
ZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAL4nvhsKnDU5qX+TcJSL
20cn6ttj3IPgGL9lERRWXXpDrJcp/fzW0XPRK6cIOVvaGFAGBZbYW7QcodCfPGiG
Z6L/8s2AOvdkmKNZzCMpIoqJQolxEd6jSK2yZalIeHZt2TAjDcYNH+QoebpHCiBx
/ocdokdMMO50vwFSoZ/y2xt88+NxoRL3C/DD0dtn1h1VF4WM7C6B9ncdpRkDpJlZ
FcvWwZKbJw7YCvlVjSIv13rD0RbT+B9Rzmu2aF4jgqrNJ4fwwJ5ydjZKr7AP4OpA
gV2WAa4kj9o6j0P5e7B+RuKtWOeG1O/1hDf9QW30giRp4J3qrJm0MEFz1bKb7gZR
6acCAwEAAaOBuzCBuDATBgNVHSUEDDAKBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAA
MB0GA1UdDgQWBBRw6sSzzzBF2+So99QXlIdlvp7WCjAfBgNVHSMEGDAWgBT7QVPS
OdCI5TuZaQMIZRU0KjTPMDBTBgNVHR8ETDBKMEigRqBEhkJodHRwOi8vY3JsLmNs
b3VkZmxhcmUuY29tLzA2YjRmNTY4LThmNDctNDEyZi05MmFlLTU3ZTkzMjcxYmVj
OS5jcmwwDQYJKoZIhvcNAQELBQADggEBAIBPXpif4MRisoyS4JzjnHeiy4IlhOX/
7lWylchtmxleTrd3g6bbLrvGs6jwphLatZhi/CCmm4O3FlttYrggXQBz4eRMK6Hs
8RID7CEH1RzxLGdukqNPzbW4k329lS9ULtkR0++WTEef8/+pMmLExFNIbUqZHzkE
NMoYNn75KpkZ6r88Q/vSnXLSyxf4dMWzFL1WWmBalRIwIa/l+4GSERpQx4ASBjNJ
pvg1XJFjjZyYy8oap6KIUJH7Fj/vWYE8xnx6hkiTfGV1SGQYVNT9gPSXRk9vT7pV
AocwwZ3J7GgKSxo5gykn+EJ048EjBMO/xd78s0f7uZvTZ/vEZ6I6vQo=
-----END CERTIFICATE-----
EOF
chmod 777 "$CERT_FILE"

echo "==> 3. Ghi private key vào $KEY_FILE"
cat > "$KEY_FILE" <<'EOF'
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC+J74bCpw1Oal/
k3CUi9tHJ+rbY9yD4Bi/ZREUVl16Q6yXKf381tFz0SunCDlb2hhQBgWW2Fu0HKHQ
nzxohmei//LNgDr3ZJijWcwjKSKKiUKJcRHeo0itsmWpSHh2bdkwIw3GDR/kKHm6
Rwogcf6HHaJHTDDudL8BUqGf8tsbfPPjcaES9wvww9HbZ9YdVReFjOwugfZ3HaUZ
A6SZWRXL1sGSmycO2Ar5VY0iL9d6w9EW0/gfUc5rtmheI4KqzSeH8MCecnY2Sq+w
D+DqQIFdlgGuJI/aOo9D+XuwfkbirVjnhtTv9YQ3/UFt9IIkaeCd6qyZtDBBc9Wy
m+4GUemnAgMBAAECggEANMCHv6642RcvC4JWmA8YfOv4/nX8peUUWHxsOY0gD5wY
lDMFEBB0OMINbyAb8XxWhFS3VjqdbiEHTv3t3z1yIMkKjbIGKb2RjreJpzNxLqeX
etOQVohL0EwOYeEF8izVNMJ0vr3DXCNSabftekTFjKxO6aKcbHqcxnwq9FmGKWCN
JMPC0mM4Q12Gq/KrwoLzLZZxQupX0mDJvW4Y9maRPPLS8fb2lHnLXaSIZ6K79NrH
dm8TyU+iNlzUxfkthAlyWQX/K8Yfp5tf5h3qep10Zf9AXKuMyP+d/JB9AU7T0PsM
RmOpCFJdDGZimef7PpfnwioT5HcFJ5+c429F3/dyyQKBgQDnlUTHcm0nXUyKxElR
Q1jcjcKAbHNUht76ykak9uYWp4yutv/rCEl0McOPblF5B6u2RAkdS4V39CcsYDnY
xES+n64Ch6L97DJu1lrpaCUtsisWyT0bQYGdBHlbPQySIbYswwiDYZ3yZ9fnIAnV
iEZV18dfgA7fF6v0XF+bYnlyZQKBgQDSNEhBwFUGZ0/hKwKktqIFJOkQAOsuZY5Y
jWY+BNK4zT3zpOBSCqKV8VIe38xZ+kzVEKB/RQPAc7cCnbNR0rjQR9lqqiHHe5Lc
QF8Upc1Vgf9Sh1qHsj62Zx3gzzIojjwiwjnBCFv4u1Qg6/MUCcS/DexblN3bLCnn
Arw2fU1lGwKBgGa1Ux3J6BNPU8UvrPy3i8+1p4/hiXzxnC9KSu6a+g0OHlzWmMYa
lMlN0NfqK4QsHMHnhstRVU6QIFeUDdPPqFWK6FgC5A0OFogF1agzIloT7PxcIBfY
g62p8FDA0LR28x8DGOF8B9scpyrAkNv9ZoRoAOqgFvhmvULRPS3jDM3pAoGBALp9
Fen3l7dhqvWqceLuANotf/PpzLzR7rLTZ/T31HeN5zukeDtxIgODIIcxqBvfu5B/
+tROx2BTiPbyMCgUmlB2ngZKwEM5d/adyX0JCB2ngnyWhxPCaG7tFw3e5LIkVmfE
Bvch0m7ey2mVy4dojzutP5eUgCu1h8timtaA3kwnAoGAfs8kfuMK7f+OMHsHICQT
vWeavEoW/UsZ+b9LW1NECPqnvAEvf4/Rz0m4U3fXCY8Lpvb+XcVxzVEnc4yYYpYO
gqvqYmCYmok1XJ1OUJMBW7lapI3k9JS/IXBmPArVpRJOKizCS0/Wpb/gQK7eXPHi
ndHOBMWcjSzYjCq5pxCF0gw=
-----END PRIVATE KEY-----
EOF
chmod 777 "$KEY_FILE"

echo "==> 4. Kiểm tra quyền truy cập"
ls -l "$CERT_DIR"

echo "✅ SSL certificate và private key đã được cài đặt."
